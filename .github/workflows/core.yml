name: Build sing-box Core

on:
  # 1. 添加 'workflow_dispatch' 触发器，让您可以手动运行此工作流
  # 这会在 Actions 页面生成一个 "Run workflow" 按钮。
  workflow_dispatch:
    inputs:
      start_build:
        description: '勾选以确认开始构建 (Click to start build)'
        required: true
        type: boolean
        default: false

jobs:
  build:
    # 仅当点击 "Run workflow" 并将 "确认开始构建" 设置为 true 时才运行。
    # 这就是您期望的“点击start按钮可以开始action”的逻辑。
    if: github.event.inputs.start_build == true
    strategy:
      fail-fast: false # 即使一个构建失败，也继续运行矩阵中的其他构建
      # 2. 使用构建矩阵，定义所有需要构建的平台和架构组合
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            name: linux-amd64
          - os: macos-latest
            arch: amd64
            name: macos-amd64
          - os: macos-latest
            arch: arm64
            name: macos-arm64

    # 在与矩阵中的 'os' 匹配的虚拟机上运行
    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.name }} # 为每个任务设置一个清晰的名称

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # 您可以根据项目需要更改 Go 的版本

      - name: Build the binary
        run: |
          # 根据不同的操作系统和架构设置环境变量并构建
          # GOOS 会被自动设置为 'linux' 或 'darwin'
          # GOARCH 会使用矩阵中定义的 'amd64' 或 'arm64'
          export GOOS=${{ runner.os == 'Linux' && 'linux' || 'darwin' }}
          export GOARCH=${{ matrix.arch }}
          export CGO_ENABLED=0 # 编译静态二进制文件通常不建议开启CGO

          # 构建命令，输出文件名为 sing-box-平台-架构
          go build -trimpath -ldflags="-s -w" -o "sing-box-${{ matrix.name }}" .
        
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # 使用矩阵中的 'name' 来命名产物，使其清晰可辨
          name: sing-box-${{ matrix.name }}
          # 上传构建出的二进制文件
          path: sing-box-${{ matrix.name }}
          # 设置产物保留天数
          retention-days: 7
